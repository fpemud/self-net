#!/usr/bin/python2
# -*- coding: utf-8; tab-width: 4; indent-tabs-mode: t -*-

import os
import sys
import shutil
import tempfile
import daemon
import logging
from gi.repository import GLib

sys.path.append('/usr/lib/selfnetd')
sys.path.append('/usr/lib/selfnetd/modules')		# fixme
from sn_util import SnUtil
from sn_param import SnParam
from sn_command_argument import SnCommandArgument
from sn_manager_config import SnConfigManager
from sn_manager_local import SnLocalManager
from sn_manager_peer import SnPeerManager
from sn_subcmd import SnSubCmdMain

param = SnParam()
parseResult = SnCommandArgument()

# some assistant sub command
if parseResult.subcmd == "generate_ca_cert":
	SnSubCmdMain(param).generateCaCert()
	sys.exit(0)
elif parseResult.subcmd == "generate_cert":
	SnSubCmdMain(param).generateCert(parseResult.hostname, parseResult.out_dir, parseResult.export)
	sys.exit(0)
else:
	assert parseResult.subcmd == ""

# the main process
try:
	# create directory
	SnUtil.mkDir(param.logDir)
	SnUtil.mkDirAndClear(param.runDir)
	param.tmpDir = tempfile.mkdtemp(prefix="selfnetd-")

	# daemonize
	dc = daemon.DaemonContext(pidfile=param.pidFile)
	if parseResult.daemonize:
		dc.open()
	try:
		# set logging parameter
		if parseResult.daemonize:
			logging.getLogger().addHandler(logging.FileHandler(param.logFile))
		else:
			logging.getLogger().addHandler(logging.StreamHandler(sys.stderr))

		if parseResult.debug_level is not None:
			if parseResult.debug_level == "CRITICAL":
				logLevel = logging.CRITICAL
			elif parseResult.debug_level == "ERROR":
				logLevel = logging.ERROR
			elif parseResult.debug_level == "WARNING":
				logLevel = logging.WARNING
			elif parseResult.debug_level == "INFO":
				logLevel = logging.INFO
			elif parseResult.debug_level == "DEBUG":
				logLevel = logging.DEBUG
			else:
				assert False
			logging.getLogger().setLevel(logLevel)

		# create main loop
		param.mainloop = GLib.MainLoop()

		# create managers
		param.configManager = SnConfigManager(param)
		param.localManager = SnLocalManager(param)
		param.peerManager = SnPeerManager(param)

		# start main loop
		param.mainloop.run()
	finally:
		if param.peerManager is not None:
			param.peerManager.dispose()
			param.peerManager = None
		if param.localManager is not None:
			param.localManager.dispose()
			param.localManager = None
		if param.configManager is not None:
			param.configManager.dispose()
			param.configManager = None
		logging.shutdown()
		dc.close()
finally:
	# shouldn't remove log directory
	if param.tmpDir is not None and os.path.exists(param.tmpDir):
		shutil.rmtree(param.tmpDir)
	if os.path.exists(param.runDir):
		shutil.rmtree(param.runDir)

